import os, sys, csv, json
from cve_searchsploit import update_db as update_cve_db
from progressbar import ProgressBar
sys.path.append(os.path.join(os.path.dirname(__file__), '../'))
from functions import *

thisDir = os.path.dirname(__file__)

def update_edb():
  update_cve_db()
  PoCList = {}
  with open(os.path.join(thisDir, 'exploitdb/files_exploits.csv'), 'r') as f:
    reader = csv.reader(f)
    # skip header
    # ['id', 'file', 'description', 'date_published', 'author', 'type', 'platform', 'port', 'date_added', 'date_updated', 'verified', 'codes', 'tags', 'aliases', 'screenshot_url', 'application_url', 'source_url']
    next(reader)
    for row in reader:
      PoCList[row[0]] = {}
      PoCList[row[0]]['file'] = os.path.join(thisDir, 'exploitdb', row[1])
      PoCList[row[0]]['description'] = row[2]
      PoCList[row[0]]['date_published'] = datetime.strptime(row[3], '%Y-%m-%d').strftime('%Y-%m-%d %H:%M:%S')
  with open(os.path.join(thisDir, 'exploitdb_mapping_PoC.json'), 'w') as f:
    json.dump(PoCList, f, indent=4)
  
  # insert new PoC data to DB
  with open(os.path.join(thisDir, 'exploitdb_mapping.json'), 'r') as f:
    edb_cve_mapping = json.load(f)
  db_conn = connectPoCDB()
  PoCurlList = getPoCurlList(db_conn)

  print("Importing to Database...")
  pCnt = 0
  with ProgressBar(max_value=len(PoCList)) as pbar:
    for edbid in PoCList:
      PoCurl = 'https://www.exploit-db.com/exploits/' + edbid
      pCnt += 1
      pbar.update(pCnt)
      if PoCurl in PoCurlList:
        continue
      PoCurlList.append(PoCurl)
      PoCdata = {}
      PoCdata['url'] = PoCurl
      PoCdata['path'] = PoCList[edbid]['file']
      PoCdata['description'] = PoCList[edbid]['description']
      PoCdata['created_at'] = PoCList[edbid]['date_published']
      PoCdata['signatures'] = getSignFromPoC(PoCdata['path'])
      CVEList = edb_cve_mapping[edbid]
      if not CVEList:
        CVEList = ['None']
      for cve in CVEList:
        PoCdata['cve'] = cve
        insertPoCDB(PoCdata, db_conn)
  closePoCDB(db_conn)


update_edb()